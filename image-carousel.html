<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">

<dom-module id="image-carousel">
  <template>
    <style >
      :host {
        @apply --layout;
        @apply --layout-center;
        position: relative;
        width: 100%;
      }

      .dots[selected-item] {
        background-color: var(--selected-dot-background, rgba(119, 119, 119, 1));
      }

      :host ::slotted(*) {
        min-width: 100%;
        @apply --slotted-content-mixin;
      }

      #image-container {
        @apply --layout;
        min-width: 100%;
        overflow-x: hidden;
        @apply --image-container-mixin;
      }

      .navigation-icons {
        @apply --layout;
        @apply --layout-center;
        position: absolute;
        height: calc(var(--iron-icon-height, 24px) + 15px);
        background: var(--image-scroller-navigation-icon-color, rgba(255, 255, 255, 1));
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
                    0 1px 5px 0 rgba(0, 0, 0, 0.12),
                    0 3px 1px -2px rgba(0, 0, 0, 0.2);
        transition: box-shadow 0.28s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        @apply --navigation-icon-mixin;
      }

      .navigation-icons:hover {
        box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14),
                    0 1px 10px 0 rgba(0, 0, 0, 0.12),
                    0 2px 4px -1px rgba(0, 0, 0, 0.4);
        @apply --navigation-icon-hover-mixin;
      }

      .navigation-icons[hidden] {
        visibility: hidden;
      }

      .left-icon {
        left: calc(var(--iron-icon-width, 24px)/-2);
        @apply --left-navigation-icon-mixin;
      }

      .right-icon {
        right: calc(var(--iron-icon-width, 24px)/-2);
        @apply --right-navigation-icon-mixin;
      }

      .dots-container[hidden] {
        display: none;
      }

      .dots-container {
        @apply --layout;
        position: absolute;
        bottom: 11px;
        left: 50%;
        @apply --dots-container-mixin;
      }

      .dots {
        height: 7px;
        width: 7px;
        margin: 2px;
        border-radius: 50%;
        cursor: pointer;
        border: 1px solid var(--dots-border-color, rgba(119, 119, 119, 1));
        @apply --dots-mimxin;
      }

    </style>
    <div class="navigation-icons left-icon" on-tap="_showPreviousImage" hidden$="[[_hideLeftIcon]]">
      <iron-icon icon="chevron-left"></iron-icon>
    </div>
    <div id="image-container">
      <slot attribute="images"></slot>
    </div>
    <div class="navigation-icons right-icon" on-tap="_showNextImage" hidden$="[[_hideRightIcon]]">
      <iron-icon icon="chevron-right"></iron-icon>
    </div>
    <div class="dots-container" hidden$="[[hideDots]]">
      <template is="dom-repeat" items="[[_imageArray]]" on-dom-change="_changeDotSelection">
        <div class="dots" id$="dot[[index]]" on-tap="_dotClicked"></div>
      </template>
     </div>
  </template>
  <script>
    /**
     * `image-scroller`
     *
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class ImageScroller extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'image-carousel'; }
      static get properties() {
        return {
          /**
           * Boolean value to decide if images should change automatically.
           * Navigation buttons will always be hidden if this is true.
           */
          autoscroll: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
            observer: '_autoScrollComputation'
          },

          /**
           * Boolean to hide the dots used for depicting current selected image and number of images.
           */
          hideDots: {
            type: Boolean,
            value: false
          },

          /**
           * Gives index of image on display (count starts from 0).
           */
          currentSelectedItem: {
            type: Number,
            value: 0
          },

          /**
           * Boolean to hide navigation icons
           */
          hideIcons: {
            type: Boolean,
            value: false
          },

          /**
           * Boolean to hide left navigation icon
           */
          _hideLeftIcon: {
            type: Boolean,
            computed: '_calcLeftArrowsVal(autoscroll, hideIcons)'
          },

          /**
           * Boolean to hide right navigation icon
           */
          _hideRightIcon: {
            type: Boolean,
            computed: '_calcRightArrowsVal(autoscroll, hideIcons)'
          },

          /**
           * Gives total number of images/items in the carousel
           */
          _numberOfImages: {
            type: Number
          },

          /**
           * */
          _imageArray: {
            type: Array,
            computed: '_imagesCountChanged(_numberOfImages)'
          },
          _intervalTrigger: {
            type: Number
          }
        };
      }

      get container() {
        return this.$['image-container'];
      }

      connectedCallback() {
        super.connectedCallback();
        this._computeNumberOfImages();
      }

      _computeNumberOfImages() {
        this._numberOfImages = this.querySelectorAll('.scolling-images').length;
      }

      _changeDotSelection() {
        this._dotClicked({model:{index: this.currentSelectedItem}});
      }

      _dotClicked(e) {
        this.shadowRoot.querySelector("#dot"+this.currentSelectedItem).removeAttribute("selected-item");
        this.shadowRoot.querySelector("#dot"+e.model.index).setAttribute("selected-item", true);
        this.container.scrollLeft = e.model.index * this._getRect().width;
        this.currentSelectedItem = e.model.index;
      }

      _imagesCountChanged(numberOfImages) {
        return new Array(numberOfImages);
      }

      _autoScrollComputation() {
        this.autoscroll ? this._autoScroll() : clearInterval(this._intervalTrigger);
      }

      _autoScroll() {
        let rect;
        this._intervalTrigger = setInterval(function() {
          rect = this._getRect();
          this.container.scrollLeft < (this._numberOfImages-1) * rect.width ?
          (this.container.scrollLeft += rect.width,
            this._dotClicked({model:{index:this.currentSelectedItem+1}})) :
          (this.container.scrollLeft = 0,
            this._dotClicked({model:{index:0}}));
        }.bind(this), 1000);

      }

      _getRect() {
        return this.container.getBoundingClientRect();
      }

      _calcRightArrowsVal(autoscrol, hideIconsl) {
        return autoscroll || hideIcons || (this._getRect().width ? this.container.scrollLeft >= (this._numberOfImages-1) * this._getRect().width : false);
      }

      _calcLeftArrowsVal(autoscroll, hideIcons) {
        return autoscroll || hideIcons || this.container.scrollLeft === 0;
      }

      _showPreviousImage() {
        this.container.scrollLeft -= this._getRect().width;
        this._dotClicked({model:{index:this.currentSelectedItem-1}});
        this._setProperty('_hideRightIcon', this._calcRightArrowsVal(this.autoscroll, this.hideIcons));
        this._setProperty('_hideLeftIcon', this._calcLeftArrowsVal(this.autoscroll, this.hideIcons));
      }

      _showNextImage() {
        this.container.scrollLeft += this._getRect().width;
        this._dotClicked({model:{index:this.currentSelectedItem+1}});
        this._setProperty('_hideRightIcon', this._calcRightArrowsVal(this.autoscroll, this.hideIcons));
        this._setProperty('_hideLeftIcon', this._calcLeftArrowsVal(this.autoscroll, this.hideIcons));
      }

    }

    window.customElements.define(ImageScroller.is, ImageCarousel);
  </script>
</dom-module>
