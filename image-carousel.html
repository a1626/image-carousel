<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">

<!--
  `image-carousel` as the name suggests is a carousel element.

  #### Example
    <image-carousel>
      <template slot="images" is="dom-repeat" items='["https://c2.staticflickr.com/2/1217/4607963354_e1a8fea210_z.jpg", "https://cs1.livemaster.ru/storage/e6/45/00b119c13ed9f8b4dc6363a60d--materialy-dlya-tvorchestva-nabor-dlya-vyshivki-biserom-belyj-ti.jpg", "https://tse4.mm.bing.net/th?id=ORT.TH_470633631&pid=1.12&eid=G.470633631"]'>
        <img class="scolling-images" src="[[item]]" width="100px" height="350px">
      </template>
    </image-carousel>

  #### Styling

  Custom property | Description | Default
  ----------------|-------------|---------
  `--selected-dot-background` | Fill for selected dot | `rgba(119, 119, 119, 1)`
  `--slotted-content-mixin` | Mixin applied to slot element | {}
  `--image-container-mixin` | Mixin applied to image container | {}
  `--image-carousel-navigation-icon-color` | Background color of navigation icons | `rgba(255, 255, 255, 1)`
  `--navigation-icon-mixin` | Mixin applied to navigation icons | {}
  `--navigation-icon-hover-mixin` | Mixin applied to navigation icon in focus | {}
  `--left-navigation-icon-mixin` | Mixin applied to left navigation icon | {}
  `--right-navigation-icon-mixin` | Mixin applied to right navigation icon | {}
  `--dots-container-mixin` | Mixin applied to dots container | {}
  `--dots-border-color` | border color of dots | `rgba(119, 119, 119, 1)`
  `--dots-mimxin` | Mixin applied to dots | {}



      @customElement
      @polymer
      @demo demo/index.html
 -->
<dom-module id="image-carousel">
  <template>
    <style >
      :host {
        @apply --layout;
        @apply --layout-center;
        position: relative;
        width: 100%;
      }

      .dots[selected-item] {
        background-color: var(--selected-dot-background, rgba(119, 119, 119, 1));
      }

      :host ::slotted(*) {
        min-width: 100%;
        @apply --slotted-content-mixin;
      }

      #image-container {
        @apply --layout;
        min-width: 100%;
        overflow-x: hidden;
        @apply --image-container-mixin;
      }

      .navigation-icons {
        @apply --layout;
        @apply --layout-center;
        position: absolute;
        height: calc(var(--iron-icon-height, 24px) + 15px);
        background: var(--image-carousel-navigation-icon-color, rgba(255, 255, 255, 1));
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
                    0 1px 5px 0 rgba(0, 0, 0, 0.12),
                    0 3px 1px -2px rgba(0, 0, 0, 0.2);
        transition: box-shadow 0.28s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        @apply --navigation-icon-mixin;
      }

      .navigation-icons:hover {
        box-shadow: 0 4px 5px 0 rgba(0, 0, 0, 0.14),
                    0 1px 10px 0 rgba(0, 0, 0, 0.12),
                    0 2px 4px -1px rgba(0, 0, 0, 0.4);
        @apply --navigation-icon-hover-mixin;
      }

      .navigation-icons[hidden] {
        visibility: hidden;
      }

      .left-icon {
        left: calc(var(--iron-icon-width, 24px)/-2);
        @apply --left-navigation-icon-mixin;
      }

      .right-icon {
        right: calc(var(--iron-icon-width, 24px)/-2);
        @apply --right-navigation-icon-mixin;
      }

      .dots-container[hidden] {
        display: none;
      }

      .dots-container {
        @apply --layout;
        position: absolute;
        bottom: 11px;
        left: 50%;
        @apply --dots-container-mixin;
      }

      .dots {
        height: 7px;
        width: 7px;
        margin: 2px;
        border-radius: 50%;
        cursor: pointer;
        border: 1px solid var(--dots-border-color, rgba(119, 119, 119, 1));
        @apply --dots-mimxin;
      }

    </style>
    <div class="navigation-icons left-icon" on-tap="_showPreviousImage" hidden$="[[_hideLeftIcon]]">
      <iron-icon icon="chevron-left"></iron-icon>
    </div>
    <div id="image-container">
      <slot attribute="images"></slot>
    </div>
    <div class="navigation-icons right-icon" on-tap="_showNextImage" hidden$="[[_hideRightIcon]]">
      <iron-icon icon="chevron-right"></iron-icon>
    </div>
    <div class="dots-container" hidden$="[[hideDots]]">
      <template is="dom-repeat" items="[[_imageArray]]" on-dom-change="_changeDotSelection">
        <div class="dots" id$="dot[[index]]" on-tap="_dotClicked"></div>
      </template>
     </div>
  </template>
  <script>
    class ImageCarousel extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'image-carousel'; }
      static get properties() {
        return {
          /**
           * Boolean value to decide if images should change automatically.
           * Navigation buttons will always be hidden if this is true.
           */
          autoscroll: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
            observer: '_autoScrollComputation'
          },

          /**
           * Boolean to hide the dots used for depicting current selected image and number of images.
           */
          hideDots: {
            type: Boolean,
            value: false
          },

          /**
           * Gives index of image on display (count starts from 0).
           */
          currentSelectedItem: {
            type: Number,
            value: 0
          },

          /**
           * Boolean to hide navigation icons
           */
          hideIcons: {
            type: Boolean,
            value: false
          },

          /**
           * Boolean to hide left navigation icon
           */
          _hideLeftIcon: {
            type: Boolean,
            computed: '_calcLeftArrowsVal(autoscroll, hideIcons)'
          },

          /**
           * Boolean to hide right navigation icon
           */
          _hideRightIcon: {
            type: Boolean,
            computed: '_calcRightArrowsVal(autoscroll, hideIcons)'
          },

          /**
           * Gives total number of images/items in the carousel
           */
          _numberOfImages: {
            type: Number
          },

          /**
           * Internal element to emulate array of images to create selector dots
           */
          _imageArray: {
            type: Array,
            computed: '_imagesCountChanged(_numberOfImages)'
          },

          /**
           * Internal element to store the id of `setInterval` function
           */
          _intervalTrigger: {
            type: Number
          }
        };
      }

      /**
       * Returns the container which contains the images.
       */
      get container() {
        return this.$['image-container'];
      }

      connectedCallback() {
        super.connectedCallback();
        this._computeNumberOfImages();
      }

      /**
       * Calculates number of images presented to the carousel.
       */
      _computeNumberOfImages() {
        this._numberOfImages = this.querySelectorAll('.scolling-images').length;
      }

      /**
       * Dom change event for when dots are ready so as to select the correct dot
       */
      _changeDotSelection() {
        this._dotClicked({model:{index: this.currentSelectedItem}});
      }

      /**
       * Changes the dot selection.
       * @param {MouseEvent} event
       */
      _dotClicked(e) {
        let elem = this.shadowRoot.querySelector("#dot"+this.currentSelectedItem)
        if(elem) {
          elem.removeAttribute("selected-item");
          this.shadowRoot.querySelector("#dot"+e.model.index).setAttribute("selected-item", true);
          this.container.scrollLeft = e.model.index * this._getRect().width;
          this.currentSelectedItem = e.model.index;
        }
      }

      /**
       * Returns dummy array of same size as that of images.
       * @param {Number} numberOfImages
       * @return {Array}
       */
      _imagesCountChanged(numberOfImages) {
        return new Array(numberOfImages);
      }

      /**
       * Observer on autoscroll to turn on and off the feature.
       */
      _autoScrollComputation() {
        this.autoscroll ? this._autoScroll() : clearInterval(this._intervalTrigger);
      }

      /**
       * Turns autoscroll on
       */
      _autoScroll() {
        let rect;
        this._intervalTrigger = setInterval(function() {
          rect = this._getRect();
          this.container.scrollLeft < (this._numberOfImages-1) * rect.width ?
          (this.container.scrollLeft += rect.width,
            this._dotClicked({model:{index:this.currentSelectedItem+1}})) :
          (this.container.scrollLeft = 0,
            this._dotClicked({model:{index:0}}));
        }.bind(this), 1000);

      }

      /**
       * Returns details regarding the container
       * @return {Object}
       */
      _getRect() {
        return this.container.getBoundingClientRect();
      }

      /**
       * Calculates visibility of right navigation arrow.
       * @return {Boolean}
       */
      _calcRightArrowsVal(autoscroll, hideIcons) {
        return autoscroll || hideIcons || (this._getRect().width ? this.container.scrollLeft >= (this._numberOfImages-1) * this._getRect().width : false);
      }

      /**
       * Calculates visibility of left navigation arrow
       * @return {Boolean}
       */
      _calcLeftArrowsVal(autoscroll, hideIcons) {
        return autoscroll || hideIcons || this.container.scrollLeft === 0;
      }

      /**
       * Changes selected image to previous image in the carousel
       */
      _showPreviousImage() {
        this.container.scrollLeft -= this._getRect().width;
        this._dotClicked({model:{index:this.currentSelectedItem-1}});
        this._setProperty('_hideRightIcon', this._calcRightArrowsVal(this.autoscroll, this.hideIcons));
        this._setProperty('_hideLeftIcon', this._calcLeftArrowsVal(this.autoscroll, this.hideIcons));
      }

      /**
       * Changes selected image to next image in the carousel
       */
      _showNextImage() {
        this.container.scrollLeft += this._getRect().width;
        this._dotClicked({model:{index:this.currentSelectedItem+1}});
        this._setProperty('_hideRightIcon', this._calcRightArrowsVal(this.autoscroll, this.hideIcons));
        this._setProperty('_hideLeftIcon', this._calcLeftArrowsVal(this.autoscroll, this.hideIcons));
      }

    }

    window.customElements.define(ImageCarousel.is, ImageCarousel);
  </script>
</dom-module>
